---
title: "Cytoexplorer Flow Cytometry Analysis"
author: "Julie Chuong"
date: "4/3/2022"
output: html_document
---
This is notebook is to show you how to use the package CytoexploreR to analyze flow cytometry data from the Cytek Aurora. 
This vignette more worthwhile if you have one or two flow datasets, not a timecourse, ie. multiple subdirectories
of flow data, one for each sampling day of a multiple day timecourse. 
For a vignette that analyzes timecourse flow data, see the our Vignette - Timecourse Flow. 

Install CytoExplorer package and requirements (Skip if already installed)
```{r}
library(BiocManager)
install.packages("cytolib", "flowCore", "flowWorkspace", "openCyto")
```

Install CytoExploreR from GitHub (Skip is already installed)
```{r}
library(devtools)
devtools::install_github("DillonHammill/CytoExploreR")
```

Load required packages
```{r, include = FALSE, echo=FALSE}
library(CytoExploreR)
library(tidyverse)
library(ggridges)
```

## Vignette Dataset

These samples are of GAP1 CNV reporter strain (DGY1657), in which a mCitrine gene
was inserted upstream of the *GAP1* promoter and coding sequence, were incubated overnight at 30C in 
glutamine-limited media. Additionally, there was one sample each of
3 control strains: zero copy 'unstained' control (DGY1) that has no mCitrine, one copy control (DGY500) in
which the mCitrine gene was inserted in neutral locus that doesn't undergo copy number
variation under glutamine-limited growth, and two copy control (DGY1315) containing two inserted copies of
mCitrine in neutral loci.
In each sample, 100,000 events were measured on the Cytek Aurora Flow Cytometer for mCitrine fluorescence
(excitation wavelength = 516, emission wavelength = 529 ) via the B2-A channel, forward scatter (FSC), and 
side scatter (SSC).
Note that you may have used a different channel depending on your cell stain. 

## Set working directory and get list of subdirectories
Place your FCS files in a directory. Multiple subdirectories containing FCS files are OK. 

*Note 1* You can only load in one folder's worth of FCS files at a time. In this vignette, 
we put all of our FCS data files in one subdirectory named FCS_files. There is one FSC file per sample.
In total, there are 4 FSC files. 

*Note 2* You should NOT manually rename your FCS files after exporting it from the Cytek. 
In other words, files should have their original names from the machine. 
"Renaming the files manually is not recommended as it does not update the associated keywords contained in the FCS files"
(Source: https://github.com/DillonHammill/CytoExploreR/issues/85). If files need to renamed, do so on on the Cytek
software and re-export the FCS files.  

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
knitr::opts_knit$set(root.dir = "/Volumes/GoogleDrive/My Drive/greshamlab/projects/EE_GAP1_ArchMuts_Summer2021/data/vignette_simple_data_workingcopy/FCS_files")
```

```{r}
getwd()
folders = list.dirs()[-1]
folders
```

## Version name
Choose a name to be used for all output files including the gating template and associated flow data and graphs.
In this vignette, we will set it to my initials, date, and version 1. 
```{r}
version_name = "my_initials_date_v1"
```


## STEP 1: Load in sample sheet
Here we assume the sample sheet metadata file is already in the working directory. 
Provide the file path to the sample sheet (metadata). 
```{r}
exp_details_path = list.files(path = ".", pattern = "sample_sheet_vignette_simple.csv", full.names = T)
```

## STEP 2: Load in FCS data as a gating set
An editable markers sheet will show up on Viewer Pane. 
Edit Markers on Viewer pane by typing in "B2-A' in the marker column of the B2-A channel.
FSC and SSC are included markers by default so you don't need to edit them. 
Scroll to the bottom of the Viewer pane.
Click 'Save & Close' button at the bottom of the Viewer pane.
```{r}
my_gating_set <- cyto_setup(path = "./FCS_files", restrict=TRUE, select="fcs", details=F)
```

Add the experiment details metadata to the gating set
```{r}
experiment_details <- read_csv(exp_details_path, show_col_types = FALSE)
for(i in 1:length(names(experiment_details))){
  flowWorkspace::pData(my_gating_set)[names(experiment_details[i])]<-experiment_details[i]
}
```

Check that the experiment details were successfully attached to the gating set. 
```{r}
cyto_details(my_gating_set) %>% View()
```

By default the Experiment-Markers.csv file is named with the date created. 
Rename the autogenerated experiment-markers.csv file if you like. 
Need to do only once.
```{r}
file.rename(dir(pattern = "Experiment-Markers.csv"),"Vignette-Experiment-Markers.csv")
```

## STEP 3:  Perform gating on gating set
Gate for 1) Cells, 2) Singlets, 3) CNVS
Results in a gating file and gated data. 

**Transform the data**
Transforming the data makes it easier to interpret visually and well as to draw gates. 
For this vignette's data, when the untransformed data when plotted, the zero copy strains take up most of the coordinate plane and the one copy and two copy distributions are very close together. The fluorescence profiles/distributions of the one copy and two copy controls overlap some. They are not mutually exclusive 
which is a limitation to note. 

This is a useful article if you I want think about to choosing different transformations:
https://dillonhammill.github.io/CytoExploreR/articles/CytoExploreR-Transformations.html

In our case, it was necessary to use a logical transformation for the B2-A values and 
a log transformation for the other values. I could not use logical transformation
for all nor could I use the log transformation for all values. 

**IMPORTANT**: If you get an error message*, run the in the Console, not inside the R notebook. Make sure you reset your working directory in the Console. 

*Error in plot.new() : QuartzBitmap_Output - unable to open file 

```{r}
setwd("/Volumes/GoogleDrive/My Drive/greshamlab/projects/EE_GAP1_ArchMuts_Summer2021/data/vignette_simple_data_workingcopy")
GFP_trans <- cyto_transformer_logicle(my_gating_set,
                                      channels = c("B2-A"),
                                      widthBasis = -10
)#returns it as a list
FSC_SSC_trans <- cyto_transformer_log(my_gating_set,
                                      channels = c("FSC-A", "FSC-H", "SSC-A", "SSC-H")
) #log transform the forward and side scatter

combined_trans <- cyto_transformer_combine(GFP_trans,FSC_SSC_trans) #combine both transformations

transformed_gating_set <- cyto_transform(my_gating_set,
                                                   trans = combined_trans) #applies the the transformation and returns it as a gatingSet
```

Check the transformed data by plotting
Subset rows to plot as needed.

**IMPORTANT**: If you get an error message*, run the in the Console, not inside the R notebook. Make sure you reset your working directory in the Console. 

*Error in plot.new() : QuartzBitmap_Output - unable to open file 
```{r}

cyto_details(transformed_gating_set)
cyto_plot_explore(transformed_gating_set[c(2,14,16,17,18)], #choose rows to plot 
                  channels_x = "FSC-A",
                  channels_y = "B2-A",
                  axes_limits = "data")
```


#### Gating using the timepoints from the gating dataset.

*Note*:if you already have a gating template and don't need to draw gates,
skip the cyto_gate_draw() steps. Instead, use cyto_gatingTemplate_apply() 
to apply a gatingTemplate.csv to your gating set. 
```{r}
# cyto_gatingTemplate_apply(transformed_timepoint_gating_set, gatingTemplate= gatingTemplate.csv)
```

**IMPORTANT**: Run this in the Console not in the R Notebook if you are having trouble. 

A new window will pop out. Draw the desired gate.
Press esc when finished drawing to save the gate. 

First we gate for the cells.
```{r}
cyto_gate_draw(transformed_gating_set,
  #transformed_logicle_timept,
               parent = "root",
               alias = "Cells",
               channels = c("FSC-A","SSC-A"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv")
)
```

Then we define the singlets based on forward scatter height and width.
```{r}
cyto_gate_draw(transformed_gating_set,
               parent = "Cells",
               alias = "Single_cells",
               channels = c("FSC-A","FSC-H"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv")
)
```

Gating for CNVs using the 0,1 and 2 copy controls:
Subset the rows in the gatingset that you want to extract to overlay when drawing gates.
The row order correspond to the experimental details.  
Choose colors of the parent population and the overlay populations. 
Choose gate names

```{r}
experiment_details %>% View() #View the rows and choose which to extract
```

**IMPORTANT**: Run code in the Console not the R Notebook 
```{r}
DGY1 <- cyto_extract(transformed_gating_set, "Single_cells")[c(5,11,17)] # we chose 3 rows of DGY1 data

DGY500 <- cyto_extract(transformed_gating_set, "Single_cells")[c(1,7,13)] #we chose 3 rows of DGY500 data

DGY1315 <- cyto_extract(transformed_gating_set, "Single_cells")[c(6,12,18)] #we chose 3 rows of DGY1315 data

cyto_gate_draw(transformed_gating_set,
               parent = "Single_cells", #maps to first point color
               alias = c("zero_copy", "one_copy", "two_or_more_copy"), #Name the gate names here
               channels = c("FSC-A","B2-A"),
               axes_limits = "data",
               gatingTemplate = paste0("cytek_gating_",version_name,".csv"),
               overlay = c(DGY1, DGY500, DGY1315), #maps to remaining point colors
               point_col = c("gray", "green", "red", "blue") #choose colors
)
```

## STEP 4: Export gate-based data and non-gate-based single cell data tables with fluorescence values

This code can be run in the notebook now. 

Get cell count from each gate
```{r}
gs_pop_get_stats(transformed_timepoint_gating_set, c("Single_cells", "zero_copy", "one_copy", "two_or_more_copy")) %>%
    rename(Gate = pop, name = sample, Count = count) %>%
    left_join(experiment_details) %>%
    write_csv(paste0(version_name,"_counts.csv"))
```  

Get frequency of cells inside each gate
```{r}
  gs_pop_get_stats(transformed_timepoint_gating_set, c("Single_cells","zero_copy", "one_copy", "two_or_more_copy"), type = "percent") %>%
    rename(Gate = pop, name = sample, Frequency = percent) %>%
    left_join(experiment_details) %>%
    write_csv(paste0(version_name,"_freq.csv"))
```

Get single cell raw fluorescence data (NOT based on gates)
Compute the normalized B2-A fluoresence over cell size forward scatter area (FSC-A)
```{r}
timepoint_raw_list <- cyto_extract(transformed_timepoint_gating_set, parent = "Single_cells", raw = TRUE, channels = c("FSC-A", "B2-A")) #raw flow data of each single cell as a list of matrices

map_df(timepoint_raw_list, ~as.data.frame(.x), .id="name") %>% #convert to df, put list name in new column
  mutate(name = as.factor(name)) %>%  #convert `name` to factor
  left_join(experiment_details) %>% #join by name column to add metadata
  mutate(B2A_FSC = `B2-A`/`FSC-A`) %>%  #compute normalized fluorescence
  write_csv(paste0(version_name,"_SingleCellDistributions.csv"))
```
